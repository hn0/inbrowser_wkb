<!DOCTYPE html>
<html>
<head>
    <title>WKB poc showcase page</title>

    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/ol3/4.6.1/ol.css">
    <style type="text/css">
        body, #wrapper {
            width: 100%
        }
        #wrapper{
            margin: auto 10px;
        }
        .mapcontainer{
            width: 40%;
            height: 400px;
            text-align: center;
            float: left;
        }
        .map {
            width: 100%;
            height: 100%;
        }
        #results{
            clear: both;
        }
    </style>


    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/ol3/4.6.1/ol.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.4.4/proj4.js"></script>
    <script type="text/javascript" src="js/mapctl.js"></script>

    <script type="text/javascript">

        var init = function(timeout) {
            // proj4 def should be automatized!

            if( !window.mapctl ){
                alert( 'something went wrong :( please refresh the page' );
                return;
            }

            var log_elem = document.getElementById( 'results' );
            if( log_elem ){
                var lists = log_elem.getElementsByTagName( 'ul' );
                if( lists ){
                    window.mapctl.log_element = lists[0];
                }
                var clear = log_elem.getElementsByTagName( 'input' );
                if( clear ){
                    clear[0].addEventListener( 'click', function() { window.mapctl.clear_log(); } );
                }
            }

            var req = new XMLHttpRequest();
            req.onload  = () => {

                var mapinfo = JSON.parse( req.responseText );

                // set reasonable default values
                if( !Array.isArray( mapinfo ) ){
                    mapinfo = [{
                        Geomcnt: -1,
                        EPSG:    4326,
                        Proj:    ''
                    }];
                }
                mapinfo = mapinfo.pop();

                var info = document.getElementById( 'info' );
                if( info && mapinfo.Geomcnt > 0 ){
                    var title       = document.createElement( 'p' );
                    title.className = 'plain';
                    title.appendChild( document.createTextNode( 'Sample data set size ' + mapinfo.Geomcnt + ' features.' ) );
                    info.appendChild( title );
                }

                if( mapinfo.EPSG > 0 && mapinfo.Proj ){
                    proj4.defs( 'EPSG:' + mapinfo.EPSG, mapinfo.Proj.replace("'", '') );
                }
                if( mapinfo.EPSG > 0 ){
                    window.mapctl.data_proj = 'EPSG:' + mapinfo.EPSG;
                }

                // add necessary event listeners
                ['wkb', 'wkt'].forEach( function(type){
                    var container = document.getElementById( 'map' + type );
                    if( container ){
                        _.each( container.getElementsByTagName( 'input' ), 
                                function( inp ) {
                                   inp.addEventListener( 'click', function() {
                                    window.mapctl.show_map( container, type, mapinfo.EPSG );
                                   });
                                });
                    }
                });
            };

            req.open( "GET", window.mapctl.server + 'geo', true );
            req.send();
        }
        document.addEventListener('DOMContentLoaded', init);
    </script>

</head>
<body>

    <div id="wrapper">
    
        <div id="info"></div>

        <div id="mapwkb" class="mapcontainer">
            <h2>WKB driven map</h2>
            <div class="map"></div>
            <input type="button" value="start ..." class="start" />
            <div class="timer"></div>
        </div>

        <div id="mapwkt" class="mapcontainer">
            <h2>WKT driven map</h2>
            <div class="map"></div>
            <input type="button" value="start ..." class="start" />
            <div class="timer"></div>
        </div>

        <input type="button" name="wasm" value="go experimental!">

        <div id="results">
            <h2>Results:</h2>
            <ul></ul>
            <input type="button" value="clear" />
        </div>

    </div>

</body>
</html>